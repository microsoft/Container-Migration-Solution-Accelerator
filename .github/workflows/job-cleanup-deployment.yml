name: Cleanup Deployment Job

permissions:
  contents: read
  actions: read

on:
  workflow_call:
    inputs:
      runner_os:
        description: 'Runner OS (ubuntu-latest or windows-latest)'
        required: true
        type: string
      trigger_type:
        description: 'Trigger type (workflow_dispatch, pull_request, schedule)'
        required: true
        type: string
      cleanup_resources:
        description: 'Cleanup Deployed Resources'
        required: false
        default: false
        type: boolean
      existing_webapp_url:
        description: 'Existing Container WebApp URL (Skips Deployment)'
        required: false
        default: ''
        type: string
      RESOURCE_GROUP_NAME:
        description: 'Resource Group Name to cleanup'
        required: true
        type: string
      AZURE_LOCATION:
        description: 'Azure Location'
        required: true
        type: string
      AZURE_ENV_OPENAI_LOCATION:
        description: 'Azure OpenAI Location'
        required: true
        type: string
      ENV_NAME:
        description: 'Environment Name'
        required: true
        type: string
      IMAGE_TAG:
        description: 'Docker Image Tag'
        required: true
        type: string

jobs:
  cleanup-deployment:
    runs-on: ${{ inputs.runner_os }}
    continue-on-error: true
    env:
      RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
      AZURE_LOCATION: ${{ inputs.AZURE_LOCATION }}
      AZURE_ENV_OPENAI_LOCATION: ${{ inputs.AZURE_ENV_OPENAI_LOCATION }}
      ENV_NAME: ${{ inputs.ENV_NAME }}
      IMAGE_TAG: ${{ inputs.IMAGE_TAG }}

    steps:
      - name: Validate Workflow Input Parameters
        shell: bash
        env:
          INPUT_TRIGGER_TYPE: ${{ inputs.trigger_type }}
          INPUT_RUNNER_OS: ${{ inputs.runner_os }}
          INPUT_CLEANUP_RESOURCES: ${{ inputs.cleanup_resources }}
          INPUT_EXISTING_WEBAPP_URL: ${{ inputs.existing_webapp_url }}
          INPUT_RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          INPUT_AZURE_LOCATION: ${{ inputs.AZURE_LOCATION }}
          INPUT_AZURE_ENV_OPENAI_LOCATION: ${{ inputs.AZURE_ENV_OPENAI_LOCATION }}
          INPUT_ENV_NAME: ${{ inputs.ENV_NAME }}
          INPUT_IMAGE_TAG: ${{ inputs.IMAGE_TAG }}
        run: |
          echo "ðŸ” Validating workflow input parameters..."
          VALIDATION_FAILED=false
          
          # Validate trigger_type (required - alphanumeric with underscores)
          if [[ -z "$INPUT_TRIGGER_TYPE" ]]; then
            echo "âŒ ERROR: trigger_type is required but was not provided"
            VALIDATION_FAILED=true
          elif [[ ! "$INPUT_TRIGGER_TYPE" =~ ^[a-zA-Z0-9_]+$ ]]; then
            echo "âŒ ERROR: trigger_type '$INPUT_TRIGGER_TYPE' is invalid. Must contain only alphanumeric characters and underscores"
            VALIDATION_FAILED=true
          else
            echo "âœ… trigger_type: '$INPUT_TRIGGER_TYPE' is valid"
          fi
          
          # Validate runner_os (required - must be specific values)
          ALLOWED_RUNNER_OS=("ubuntu-latest" "windows-latest")
          if [[ -z "$INPUT_RUNNER_OS" ]]; then
            echo "âŒ ERROR: runner_os is required but was not provided"
            VALIDATION_FAILED=true
          elif [[ ! " ${ALLOWED_RUNNER_OS[@]} " =~ " ${INPUT_RUNNER_OS} " ]]; then
            echo "âŒ ERROR: runner_os '$INPUT_RUNNER_OS' is invalid. Allowed values: ${ALLOWED_RUNNER_OS[*]}"
            VALIDATION_FAILED=true
          else
            echo "âœ… runner_os: '$INPUT_RUNNER_OS' is valid"
          fi
          
          # Validate cleanup_resources (boolean)
          if [[ "$INPUT_CLEANUP_RESOURCES" != "true" && "$INPUT_CLEANUP_RESOURCES" != "false" ]]; then
            echo "âŒ ERROR: cleanup_resources must be 'true' or 'false', got: '$INPUT_CLEANUP_RESOURCES'"
            VALIDATION_FAILED=true
          else
            echo "âœ… cleanup_resources: '$INPUT_CLEANUP_RESOURCES' is valid"
          fi
          
          # Validate existing_webapp_url (must start with https)
          if [[ -n "$INPUT_EXISTING_WEBAPP_URL" ]]; then
            if [[ ! "$INPUT_EXISTING_WEBAPP_URL" =~ ^https:// ]]; then
              echo "âŒ ERROR: existing_webapp_url must start with 'https://', got: '$INPUT_EXISTING_WEBAPP_URL'"
              VALIDATION_FAILED=true
            else
              echo "âœ… existing_webapp_url: '$INPUT_EXISTING_WEBAPP_URL' is valid"
            fi
          fi
          
          # Validate RESOURCE_GROUP_NAME (required, Azure resource group naming convention)
          if [[ -z "$INPUT_RESOURCE_GROUP_NAME" ]]; then
            echo "âŒ ERROR: RESOURCE_GROUP_NAME is required but was not provided"
            VALIDATION_FAILED=true
          elif [[ ! "$INPUT_RESOURCE_GROUP_NAME" =~ ^[a-zA-Z0-9._\(\)-]+$ ]] || [[ "$INPUT_RESOURCE_GROUP_NAME" =~ \.$ ]]; then
            echo "âŒ ERROR: RESOURCE_GROUP_NAME '$INPUT_RESOURCE_GROUP_NAME' is invalid. Must contain only alphanumerics, periods, underscores, hyphens, and parentheses. Cannot end with period."
            VALIDATION_FAILED=true
          elif [[ ${#INPUT_RESOURCE_GROUP_NAME} -gt 90 ]]; then
            echo "âŒ ERROR: RESOURCE_GROUP_NAME '$INPUT_RESOURCE_GROUP_NAME' exceeds 90 characters"
            VALIDATION_FAILED=true
          else
            echo "âœ… RESOURCE_GROUP_NAME: '$INPUT_RESOURCE_GROUP_NAME' is valid"
          fi
          
          # Validate AZURE_LOCATION (required, Azure region format)
          if [[ -z "$INPUT_AZURE_LOCATION" ]]; then
            echo "âŒ ERROR: AZURE_LOCATION is required but was not provided"
            VALIDATION_FAILED=true
          elif [[ ! "$INPUT_AZURE_LOCATION" =~ ^[a-z0-9]+$ ]]; then
            echo "âŒ ERROR: AZURE_LOCATION '$INPUT_AZURE_LOCATION' is invalid. Must contain only lowercase letters and numbers (e.g., 'australiaeast', 'westus2')"
            VALIDATION_FAILED=true
          else
            echo "âœ… AZURE_LOCATION: '$INPUT_AZURE_LOCATION' is valid"
          fi
          
          # Validate AZURE_ENV_OPENAI_LOCATION (required, Azure region format)
          if [[ -z "$INPUT_AZURE_ENV_OPENAI_LOCATION" ]]; then
            echo "âŒ ERROR: AZURE_ENV_OPENAI_LOCATION is required but was not provided"
            VALIDATION_FAILED=true
          elif [[ ! "$INPUT_AZURE_ENV_OPENAI_LOCATION" =~ ^[a-z0-9]+$ ]]; then
            echo "âŒ ERROR: AZURE_ENV_OPENAI_LOCATION '$INPUT_AZURE_ENV_OPENAI_LOCATION' is invalid. Must contain only lowercase letters and numbers (e.g., 'australiaeast', 'westus2')"
            VALIDATION_FAILED=true
          else
            echo "âœ… AZURE_ENV_OPENAI_LOCATION: '$INPUT_AZURE_ENV_OPENAI_LOCATION' is valid"
          fi
          
          # Validate ENV_NAME (required)
          if [[ -z "$INPUT_ENV_NAME" ]]; then
            echo "âŒ ERROR: ENV_NAME is required but was not provided"
            VALIDATION_FAILED=true
          else
            echo "âœ… ENV_NAME: '$INPUT_ENV_NAME' is valid"
          fi
          
          # Validate IMAGE_TAG (required, Docker tag pattern)
          if [[ -z "$INPUT_IMAGE_TAG" ]]; then
            echo "âŒ ERROR: IMAGE_TAG is required but was not provided"
            VALIDATION_FAILED=true
          elif [[ ! "$INPUT_IMAGE_TAG" =~ ^[a-zA-Z0-9_][a-zA-Z0-9._-]{0,127}$ ]]; then
            echo "âŒ ERROR: IMAGE_TAG '$INPUT_IMAGE_TAG' is invalid. Must:"
            echo "   - Start with alphanumeric or underscore"
            echo "   - Contain only alphanumerics, underscores, periods, hyphens"
            echo "   - Be max 128 characters"
            VALIDATION_FAILED=true
          else
            echo "âœ… IMAGE_TAG: '$INPUT_IMAGE_TAG' is valid"
          fi
          
          # Fail workflow if any validation failed
          if [[ "$VALIDATION_FAILED" == "true" ]]; then
            echo ""
            echo "âŒ Parameter validation failed. Please correct the errors above and try again."
            exit 1
          fi
          
          echo ""
          echo "âœ… All input parameters validated successfully!"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi
          az --version

      - name: Setup Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Login to Azure
        shell: bash
        run: |
          az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azd auth login --client-id ${{ secrets.AZURE_CLIENT_ID }} --client-secret ${{ secrets.AZURE_CLIENT_SECRET }} --tenant-id ${{ secrets.AZURE_TENANT_ID }}
          azd config set defaults.subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Select Environment
        shell: bash
        env:
          RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          AZURE_LOCATION: ${{ inputs.AZURE_LOCATION }}
          AZURE_ENV_OPENAI_LOCATION: ${{ inputs.AZURE_ENV_OPENAI_LOCATION }}
        run: |
          set -e
          # Try to select the environment if it exists, otherwise create a minimal environment for cleanup
          azd env list
          if azd env list | grep -q "${{ env.ENV_NAME }}"; then
            echo "Environment ${{ env.ENV_NAME }} found, selecting it..."
            azd env select ${{ env.ENV_NAME }}
          else
            echo "Environment ${{ env.ENV_NAME }} not found, creating minimal environment for cleanup..."
            azd env new ${{ env.ENV_NAME }} --no-prompt
            azd env set AZURE_RESOURCE_GROUP "${RESOURCE_GROUP_NAME}"
            azd env set AZURE_SUBSCRIPTION_ID "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            azd env set AZURE_LOCATION="${AZURE_LOCATION}"
            azd env set AZURE_AI_DEPLOYMENT_TYPE="${AZURE_ENV_OPENAI_LOCATION}"
          fi

      - name: Delete deployment using azd
        shell: bash
        id: delete_rg
        run: |
          set -e
          echo "Deleting deployment..."
          azd down --purge --force --no-prompt
          echo "Deployment deleted successfully."

      - name: Logout from Azure
        if: always()
        shell: bash
        run: |
          azd auth logout || true
          az logout || echo "Warning: Failed to logout from Azure CLI"
          echo "Logged out from Azure."
      
      - name: Generate Cleanup Job Summary
        if: always()
        shell: bash
        env:
          RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          DELETE_RG_OUTCOME: ${{ steps.delete_rg.outcome }}
        run: |
          echo "## ðŸ§¹ Cleanup Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [[ "${DELETE_RG_OUTCOME}" == "success" ]]; then
            echo "| **Resource Group deletion Status** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Resource Group deletion Status** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| **Resource Group** | \`${RESOURCE_GROUP_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${DELETE_RG_OUTCOME}" == "success" ]]; then
            echo "### âœ… Cleanup Details" >> $GITHUB_STEP_SUMMARY
            echo "- Successfully initiated deletion for Resource Group \`${RESOURCE_GROUP_NAME}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Cleanup Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Cleanup process encountered an error" >> $GITHUB_STEP_SUMMARY
            echo "- Manual cleanup may be required for:" >> $GITHUB_STEP_SUMMARY
            echo "  - Resource Group: \`${RESOURCE_GROUP_NAME}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Check the cleanup-deployment job logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          fi
