name: Send Notification Job

on:
  workflow_call:
    inputs:
      trigger_type:
        description: 'Trigger type (workflow_dispatch, pull_request, schedule)'
        required: true
        type: string
      waf_enabled:
        description: 'Enable WAF'
        required: false
        default: false
        type: boolean
      EXP:
        description: 'Enable EXP'
        required: false
        default: false
        type: boolean
      existing_webapp_url:
        description: 'Existing Container WebApp URL (Skips Deployment)'
        required: false
        default: ''
        type: string
      deploy_result:
        description: 'Deploy job result (success, failure, skipped)'
        required: true
        type: string
      WEB_APPURL:
        description: 'Container Web App URL'
        required: false
        default: ''
        type: string
      RESOURCE_GROUP_NAME:
        description: 'Resource Group Name'
        required: false
        default: ''
        type: string
      QUOTA_FAILED:
        description: 'Quota Check Failed Flag'
        required: false
        default: 'false'
        type: string

env:
  GPT_MIN_CAPACITY: 100
  BRANCH_NAME: ${{ github.event.workflow_run.head_branch || github.head_ref || github.ref_name }}
  WAF_ENABLED: ${{ inputs.trigger_type == 'workflow_dispatch' && (inputs.waf_enabled || false) || false }}
  EXP: ${{ inputs.trigger_type == 'workflow_dispatch' && (inputs.EXP || false) || false }}

jobs:
  send-notification:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      accelerator_name: "Container Migration"
    steps:
      - name: Send Quota Failure Notification
        if: inputs.deploy_result == 'failure' && inputs.QUOTA_FAILED == 'true'
        shell: bash
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${{ env.accelerator_name }} deployment has failed due to insufficient quota in the requested regions.</p><p><strong>Issue Details:</strong><br>• Quota check failed for GPT model<br>• Required GPT Capacity: ${{ env.GPT_MIN_CAPACITY }}<br>• Checked Regions: ${{ vars.AZURE_REGIONS }}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Please resolve the quota issue and retry the deployment.</p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${{ env.accelerator_name }} Pipeline - Failed (Insufficient Quota)"
          }
          EOF
          )

          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send quota failure notification"

      - name: Send Deployment Failure Notification
        if: inputs.deploy_result == 'failure' && inputs.QUOTA_FAILED != 'true'
        shell: bash
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP_NAME }}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${{ env.accelerator_name }} deployment process has encountered an issue and has failed to complete successfully.</p><p><strong>Deployment Details:</strong><br>• Resource Group: ${RESOURCE_GROUP}<br>• WAF Enabled: ${{ env.WAF_ENABLED }}<br>• EXP Enabled: ${{ env.EXP }}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Please investigate the deployment failure at your earliest convenience.</p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${{ env.accelerator_name }} Pipeline - Failed"
          }
          EOF
          )
          
          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send deployment failure notification"

      - name: Send Success Notification
        if: inputs.deploy_result == 'success'
        shell: bash
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          WEBAPP_URL="${{ inputs.WEB_APPURL || inputs.existing_webapp_url }}"
          RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP_NAME }}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${{ env.accelerator_name }} deployment has completed successfully.</p><p><strong>Deployment Details:</strong><br>• Resource Group: ${RESOURCE_GROUP}<br>• Web App URL: <a href='${WEBAPP_URL}'>${WEBAPP_URL}</a></p><p><strong>Configuration:</strong><br>• WAF Enabled: ${{ env.WAF_ENABLED }}<br>• EXP Enabled: ${{ env.EXP }}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${{ env.accelerator_name }} Pipeline - Deployment Success"
          }
          EOF
          )
          
          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send success notification"

      - name: Send Existing URL Test Failure Notification
        if: inputs.deploy_result == 'skipped' && inputs.existing_webapp_url != ''
        shell: bash
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          EXISTING_URL="${{ inputs.existing_webapp_url }}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>The ${{ env.accelerator_name }} pipeline executed against the <strong>existing WebApp URL</strong>.</p><p><strong>Details:</strong><br>• Target URL: <a href='${EXISTING_URL}'>${EXISTING_URL}</a><br>• Deployment: Skipped</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${{ env.accelerator_name }} Pipeline - Existing URL Notification"
          }
          EOF
          )

          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send existing URL test failure notification"
